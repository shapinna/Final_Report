---
title: "Final report"
author: "Shanmukh"
date: "April 22, 2019"
output:
  html_document:
    toc: TRUE
    toc_float: false
    toc_depth: 4
    df_print: paged
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


**Install libraries**
```{r,message=FALSE, warning=FALSE}
library(readr) # to load the files
library(dplyr) # for data wrangling
library(stringr)# for string manipulation
library(zoo) # for filling missing values
library(corrplot)  # to access correlation functions
library(ggplot2) # for plotting
library(car) # heteroscedasticit test

```

## Exploratory Data Analysis

**Gapminder dataset**

- Load gapminder data and assign to gap_d

```{r}
gap_d <- read.csv("C:/Main/Shanmukh/MS/Indiana university/applied data science/Final project/gapminder.csv", header=TRUE)

gap<-gap_d # New data frame gap is created

```


#### About gapminder dataset

```{r}
str(gap) # structure of gap data set

summary(gap) # summary of gap dataset
```



* 41284 observations with 6 columns
* Data set is covering 197 countries across 6 regions
* On an average there are 216 records for each country across multiple years
* Data is from year 1800 to 2015
* Country, region and population are with data type factor
* Year & income are with data type integer
* life is a numeric data type
* Income has 2341 null values
* America region has 7961 records and South Asia has 1728 records in the gapminder dataset




#### Questions

* Whether life expectancy increases based on Income
* Whether  high population will have low income levels?
* Whether life expectancy improve over the years?
* Whether Income levels improved over the years?
* Whether population increased where life expectancy is more?




#### Data Transformation

Converting Population data set from factor to Numeric for performing stastical analysis

- replacing comma
```{r}
gap$population <- lapply(gap$population, gsub, pattern = ",", replacement = "", fixed = TRUE)

```


- converting population column from factor to numeric

```{r}

# converting population column from factor to numeric
gap$population <- as.numeric(as.character(gap$population)) 

```

- verify class of population column
```{r}
class(gap$population)

```


#### verify records with null values

- Verify which columns has null values
```{r}
colSums(is.na(gap)) # verify number of null values column wise
```

#### Derive missing population numbers

* As population census is taken once in 10 years same value to be considered for next 9 years

```{r}

# replacing the null population value in the data frame with previous year not null value

gap$population <-na.locf(gap$population, fromLast = FALSE) 

colSums(is.na(gap)) # verify number of null values column wise

```


- verify null value records
```{r}
 gap_null <-gap %>% 
  filter_all(any_vars(is.na(.))) %>%
  group_by(Country,region)%>%
  summarise(count_na=sum(is.na(income)))


gap_null

sum(gap_null$count_na)
```

```{r}

gap_m<-gap[is.na(gap$income),]# subset of data with missing income fields


# Data of non missing values for the countries with missing values
 gap %>% 
  filter(Country%in%gap_m$Country)%>%
  group_by(Country,region)%>%
  summarise(count_na=sum(!is.na(income)))

```


From the above analysis we can conclude all the countries with missing income data dont have single record with income details except for croatia

* Croatia has values for 196 records and only 20 records has missing income

```{r}

# Analyze the income data for Croatia
#gap[gap$Country=="Croatia",]

```

* Coratia Income data has been collected only from 1820 and prior years is not collected hence it is not logical to populate missing income values of earlier years with mean or median.

- we conclude that missing income values to the extent of 2341 needs to be omitted on need bases based on the analysis.




#### Co-relation between elements of dataset

```{r}
# subset only numeric data type columns without missing values

gap_num <- gap[complete.cases(gap),c(3,4,5)] # removing missing records and only numeric columns

cor(gap_num)

corrplot(cor(gap_num),method="ellipse")

```


* Income and life are having positive relation of 0.57

  - As income increases life expectency increases
  
* Income and population are not having relation of 0.03

  - As the correlation is near 0, there is no relation between Income and population
  
* Life and population are midly positive relation of 0.11

  - As the Population increase Life expectency increases mildly.
  

#### Scatter plot to view Correlation results {.tabset .tabset-fade .tabset-pills}

##### Income Vs Life

```{r}

plot(gap$income~gap$life,pch=19,col="blue",
     main='scatter plot of income vs life',
     xlab="Life",
     ylab='Income')
abline(lm(gap$income~gap$life),col="red",lty=2,lwd=3)

```


* Scatter plot shows that Income and Life are having linear relationship
  - both of them having considerable positive correlation


##### Population Vs Life

```{r}

plot(gap$population~gap$life,pch=19,col="blue",
     main='scatter plot of Population vs life',
     xlab="Life",
     ylab='population')
abline(lm(gap$population~gap$life),col="red",lty=2,lwd=3)

```

* Scatter plot shows Populationa and Life are having linear relationship
  - Both of them having mild positive correlation

##### Income Vs Population

```{r}


plot(gap$income~gap$population,pch=19,col="blue",
     main='scatter plot of Income vs Population',
     xlab="Population",
     ylab='Income')
abline(lm(gap$income~gap$population),col="red",lty=2,lwd=3)


```


* scatter plot shows population and Income are not having any linear relationship
  _ Both of the attributes don't have any relation



#### data for each region


```{r}
ggplot(gap[complete.cases(gap), ])+
  geom_smooth(mapping=aes(x=life,y=income,col=region))+
  labs(title="Trend of Income over life across regions",x="Life", y = "Income")+
   theme(legend.position="bottom")


```




```{r}
ggplot(gap[complete.cases(gap), ])+
  geom_smooth(mapping=aes(x=life,y=population,col=region))



```

```{r}
ggplot(gap[complete.cases(gap), ])+
  geom_smooth(mapping=aes(x=population,y=income,col=region,size=life))
```


#### Box plots and Variance analysis

##### Variance of Life across Regions

```{r}

ggplot(data=gap,mapping=aes(x=region,y=life,fill=region))+
 geom_boxplot(outlier.colour = "red", outlier.shape = 1)+
 # geom_boxplot(varwidth=TRUE)+
 theme_classic()+
 labs(title="Plot of life per region",x="Region", y = "Life")+
  stat_summary(fun.y=mean, geom="point", shape=23, size=4)+
 theme(legend.position="bottom")+
  scale_x_discrete(labels=c("Europe & Central Asia" = "Europe & C.Asia", "Middle East & North Africa" = "ME & N.Africa",
                              "East Asia & Pacific" = "E Asia & pacific"))
 # scale_x_discrete(limits=c("Europe & Central Asisa","America","Sub-Saharan Africa"))+
   # coord_flip()

```


```{r}
gap %>%
  group_by(region) %>%
  summarize(mean_life=round(mean(life)), median_life=round(median(life)),
            sd_life = round(sd(life)),
            IQR_life = round(IQR(life)),
            mad_life = round(mad(life)))%>%
  arrange(desc(mean_life))
```

* Europe and Central Asia has high mean life of 49
* south asia and Sub-saharan Africa has comparable mean_life of 37 & 38.
* south asia has outliers near life 80 and sub-saharan has outlier at high and low life.


#### Verify Distribution of Life {.tabset .tabset-fade .tabset-pills}

##### All regions

```{r}

hist(gap$life,
     col="grey75",
     main="Distribution of Life",
     #ylim=c(0,0.7),
     prob= TRUE)
curve(dnorm(x,mean(gap$life),
            sd(gap$life)),
      add=TRUE,
      col="red",
      lwd=3)

```


##### America

```{r}

hist(gap[gap$region=="America",]$life,
     col="grey75",
     main="Distribution of Life for America region",
     prob= TRUE)
curve(dnorm(x,mean(gap[gap$region=="America",]$life),
            sd(gap[gap$region=="America",]$life)),
      add=TRUE,
      col="red",
      lwd=3)
```

##### East Asia & Pacific

```{r}

hist(gap[gap$region=="East Asia & Pacific",]$life,
     col="grey75",
     main="Distribution of Life for East Asia & Pacific region",
     #ylim=c(0,0.7),
     prob= TRUE)
curve(dnorm(x,mean(gap[gap$region=="East Asia & Pacific",]$life),
            sd(gap[gap$region=="East Asia & Pacific",]$life)),
      add=TRUE,
      col="red",
      lwd=3)

```

##### Europe & Central Asia

```{r}
hist(gap[gap$region=="Europe & Central Asia",]$life,
     col="grey75",
     main="Distribution of Life for Europe & Central Asia region",
     #ylim=c(0,0.7),
     prob= TRUE)
curve(dnorm(x,mean(gap[gap$region=="Europe & Central Asia",]$life),
            sd(gap[gap$region=="Europe & Central Asia",]$life)),
      add=TRUE,
      col="red",
      lwd=3)
```


##### Middle East & North Africa

```{r}
hist(gap[gap$region=="Middle East & North Africa",]$life,
     col="grey75",
     main="Distribution of Life for Middle East & North Africa region",
     #ylim=c(0,0.7),
     prob= TRUE)
curve(dnorm(x,mean(gap[gap$region=="Middle East & North Africa",]$life),
            sd(gap[gap$region=="Middle East & North Africa",]$life)),
      add=TRUE,
      col="red",
      lwd=3)
```

##### South Asia

```{r}
hist(gap[gap$region=="South Asia",]$life,
     col="grey75",
     main="Distribution of Life for South Asia region",
     #ylim=c(0,0.7),
     prob= TRUE)
curve(dnorm(x,mean(gap[gap$region=="South Asia",]$life),
            sd(gap[gap$region=="South Asia",]$life)),
      add=TRUE,
      col="red",
      lwd=3)
```


##### Sub-Saharan Africa
```{r}
hist(gap[gap$region=="Sub-Saharan Africa",]$life,
     col="grey75",
     main="Distribution of Life for Sub-Saharan Africa region",
     #ylim=c(0,0.7),
     prob= TRUE)
curve(dnorm(x,mean(gap[gap$region=="Sub-Saharan Africa",]$life),
            sd(gap[gap$region=="Sub-Saharan Africa",]$life)),
      add=TRUE,
      col="red",
      lwd=3)





```



library(MASS)
      
truehist(gap[gap$region=="America",]$life)
# Add the density curve to the histogram
lines(density(gap[gap$region=="America",]$life))

      
  

#### Variance of Income across regions

```{r}

ggplot(data=gap,mapping=aes(x=region,y=income,fill=region))+
 geom_boxplot(outlier.colour = "red", outlier.shape = 1,na.rm = TRUE)+
 theme_classic()+
 scale_y_continuous(trans='log10')+
 labs(title="Box Plot of income per region",x="Region", y = "Income")+
  stat_summary(fun.y=mean, geom="point", shape=23, size=4,na.rm = TRUE)+
  scale_x_discrete(labels=c("Europe & Central Asia" = "Europe & C.Asia", "Middle East & North Africa" = "ME & N.Africa",
                              "East Asia & Pacific" = "E Asia & pacific"))+
    theme(legend.position="bottom")

gap[complete.cases(gap), ] %>%
  group_by(region) %>%
  summarize(mean_income=round(mean(income)), median_income=round(median(income)),
            sd_income = round(sd(income)),
            IQR_income = round(IQR(income)),
            mad_income = round(mad(income)))%>%
  arrange(desc(mean_income))

```


* Middle East & North Africa has higher mean income of 8064 with higher standard deviation of 20413
* America is in 3rd rank in mean income, however standard deviation is 6151 and IQR of 4184 denotes the data is having less variance from the mean
* huge outlier exists for regions East Asia & pacific, Middle east& North Africa, south asia & sub saharan africa




#### variance of population across regions

```{r}


ggplot(data=gap,mapping=aes(x=region,y=population,fill=region))+
 geom_boxplot(outlier.colour = "red", outlier.shape = 1,na.rm = TRUE)+
 theme_classic()+
 scale_y_continuous(trans='log10')+
 labs(title="Box Plot of Population across regions",x="Region", y = "Population")+
  stat_summary(fun.y=mean, geom="point", shape=23, size=4,na.rm = TRUE)+
  scale_x_discrete(labels=c("Europe & Central Asia" = "Europe & C.Asia", "Middle East & North Africa" = "ME & N.Africa",
                              "East Asia & Pacific" = "E Asia & pacific"))+
    theme(legend.position="bottom")

gap[complete.cases(gap), ] %>%
  group_by(region) %>%
  summarize(mean_population=round(mean(population)), median_population=round(median(population)),
            sd_population = round(sd(population)),
            IQR_population = round(IQR(population)),
            mad_population = round(mad(population)))%>%
  arrange(desc(mean_population))

```


* South Asia and East asia & Pacific has more mean population with higher standard deviation and IQR compared to other regions
* Europe and central Asia has outliers for few countries for few year has lower population
* Sub Saharan Africa has outlier for few records for low and high population



## Linear regression

#### Linear regression model

```{r}
gap_lm <- lm(life~income,data=gap) # Linear regression model


summary(gap_lm)
```

* Linear regression equation for dependent variable Life and independent variable Income

As per linear regression model y = ?? + ?? x
Life = 38.73 + 0.0009217 * Income

#### Interpretation of Linear regression model

*	?? (a in sample prediction equation) represents the y-intercept in a linear regression model 
*	?? (b in sample prediction equation) represents the slope in a linear regression model
* As per above prediction equation we can predict every unit of increase in income will reflect 0.0009217 increase in life
* As ??>0 Both Life and Income are positively related
* Test statistic t = 139.2 & P <2e-16 indicates ?? is not equal to 0  it means both Life and Income are not  independent
* As R squared = 0.3322 denotes variation in Life can be explained to the extent of 33.22% by variation in Income

- degrees of freedom 38941 indicates only 38943 records are considered due to missing income values of 2341 records out of 41284 observations


#### Correlation of dependent variable and independent variable

```{r}
cor.test(gap$life,gap$income,use="complete.obs")

```

* As correlation r = 0.576409 denotes both the variables Life and Income are having relatively positive relationship
* 95% confidence Interval is  ( 0.5697387, 0.5830034)



#### Verification of linear relationship between dependent and independent variable

Assumptions:
1)	There is a linear relationship
2)	Variation in residuals are same for small and large values
3)	Residuals follow normal probability distribution


##### Testing of linearity

```{r}
plot(gap$income~gap$life,pch=19,col="blue",
     main='scatter plot of income vs life',
     xlab="Life",
     ylab='Income')
abline(lm(gap$income~gap$life),col="red",lty=2,lwd=3)

```

As per above scatter plot we can identify that variables Life and Income are approximately in linear relationship, as regression line is inclined to upwards as the income increases.

##### Verification of outliers



```{r}
plot(gpa_sat_lm,which = 4)  # Cooks distance

```

All the observations as per cooks distance are less than 4/38943 = 1.027, hece there no impacting outliers in the data set


#### Verify the variability in the residuals is same for both large and small values for estimated Y

```{r}

plot(gap_lm$residuals~gap_lm$fitted.values,
     main="Residual vs Predicted values")
abline(h=0,col="red",lty=2,lwd=2)

```


As per above plot variability of residuals is not same for both large and small value  for estimated y

#### Statistical test for heteroscedasticity:

```{r}
ncvTest(gap_lm)

```


As the P value < 2.22e-16  is less than 0.05 we can conclude that linear regression model has heteroscedasticity

statistical test for heteroscedasticity is in line with the residual vs fitter plot above


#### Residuals to be normally distributed

```{r}
hist(gap_lm$residuals,
     col="grey75",
     main="Distribution of residuals",
     #ylim=c(0,0.7),
     prob= TRUE)
curve(dnorm(x,mean(gap_lm$residuals),
            sd(gap_lm$residuals)),
      add=TRUE,
      col="red",
      lwd=3)

plot(gpa_sat_lm,which = 2)

```


As per above plot we can conclude residuals are not normally distributed 


Since the linear regression model has heteroscedasticity  we can conclude linear regression model does not fit variables between Life and Income.

#### Introduction of intraction term

```{r}

gap_mod<- lm(life ~ income+
               as.factor(region)+population, data=gap)

summary(gap_mod)

ncvTest(gap_mod)

```

## Cluster Analysis:



Analysis on population with high income will always have high life expectancy:



.	As per linear regression model every unit increase in SAT score increase college GPA by 0.001931
.	As the slope is positive college gpa is positively related to SAT score
.	Correlation between college gpa and SAT score is 0.4087123 
o	Relation is mildly positive
o	Relation between two variables is moderate.
.	R squared is 0.167


**Conclusion:**
As R squared is 0.3322,  Variation in Life (dependent variable) to the extent of 33% is explained by variation in income(indpendent variable)

As per above scatter plot there are many people who have lower income had high life expectency

As R squared is average (33.2%), we cannot conclude income level will completely determine the life expectancy. In other words we cannot conclude high income levels will always lead to higher life expectancy. 





gap_r <-gap_r[complete.cases(gap_r), ]  # removing records with null values


#### Reducing the data set size by region and year

** Subset of gapminder data set **



 subset data of years 1950,1960,1970,1980,1990,2000,2010,2015 & region America,South Asia is considered for analysis
gap_r<-gap[gap$Year %in% c(1950,1960,1970,1980,1990,2000,2010,2015)
          & gap$region %in% c('America','South Asia'),]







View(gaps)

table(gap_am_sa$population)



gap_am_sa_n[gap_am_sa_n$population=="NULL",]


colSums(is.na(gap_am_sa_n))

gap_am_sa[gap_am_sa$Country=="Afghanistan",]

 gap[gap$Country=="French Guiana",]

gap_am_sa_n <- gap_am_sa

gap_am_sa_n$population <- lapply(gap_am_sa_n$population, gsub, pattern = ",", replacement = "", fixed = TRUE)




gt <-gap %>%
  filter(Year==c(1950,1960,1970,1980,1990,2000,2010,2015))



  




am_gap <- gap %>% 
  filter(region=="America")

table(gap$Country)

hist(gap_am_sa$life,
main="histogram")

hist(gap_am_sa$income,
main="histogram")


gap_es <- gap %>%
  dplyr::mutate(ES=Country %in% c("United States"))

gap_es %>%
  dplyr::group_by(ES)%>%
  dplyr::summarize(mean(life),median(life))

tt <- gap%>%
  dplyr::filter(Country=="United States")

tt <- head(round(gap$life),11)
tt


gap_country <- gap

gaps_stat<-gaps %>%
  group_by(region) %>%
  summarize(mean(life,na.rm=TRUE),median(life,na.rm=TRUE)
            ,mean(income,na.rm=TRUE),median(income,na.rm=TRUE)) %>%
  rename(mean_life = 'mean(life, na.rm = TRUE)', median_life = 'median(life, na.rm = TRUE)',
         mean_income ='mean(income, na.rm = TRUE)' , median_income='median(income, na.rm = TRUE)')

  str(gap_stat)

 str(gap_country) 
  

gaps_stat %>%
  filter(gap_stat$`mean(life)`==max(gap_stat$`mean_life`))








  hist(gap %>%
  filter(region=="America")%>%
  select(life))

hist(gaps$life[gap_am_sa$region=="America"])

hist(gap$life[gap$region=="Europe & Central Asia"])


hist(gap$life[gap$region=="Middle East & North Africa"])

hist(gaps$life[gap_am_sa$region=="South Asia"])





```{r}

```

